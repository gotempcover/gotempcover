generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // PgBouncer (runtime)
  directUrl = env("DIRECT_URL")     // Direct (migrations / dev)
}

enum PolicyStatus {
  DRAFT
  PAID
  ACTIVE
  CANCELLED
  EXPIRED
}

enum PaymentProvider {
  STRIPE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum DocumentKind {
  PROPOSAL
  CERTIFICATE
  TERMS
}

enum StorageProvider {
  SUPABASE
  R2
}

enum PolicyEventType {
  POLICY_CREATED
  PAYMENT_CONFIRMED
  DOCS_GENERATED
  EMAIL_SENT
  FINALIZE_RETRIED
}

model Policy {
  id               String   @id @default(cuid())
  policyNumber     String   @unique
  status           PolicyStatus @default(DRAFT)

  // Quote details
  vrm              String
  make             String?
  model            String?
  year             String?
  startAt          DateTime
  endAt            DateTime
  durationMs       BigInt
  totalAmountPence Int

  // Customer
  fullName         String
  dob              DateTime
  email            String
  licenceType      String
  address          String

  // Payment
  paymentProvider  PaymentProvider
  paymentId        String              // Recommended: Stripe Checkout Session ID (cs_...)
  paymentStatus    PaymentStatus
  currency         String              // "GBP"

  // Stripe extras (optional but strongly recommended)
  stripePaymentIntentId String?        // pi_...

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  documents        PolicyDocument[]
  events           PolicyEvent[]

  @@unique([paymentProvider, paymentId])
  @@index([email])
  @@index([vrm])
  @@index([startAt])
}

model PolicyDocument {
  id         String   @id @default(cuid())
  policyId   String
  policy     Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)

  kind       DocumentKind
  filename   String

  storageProvider StorageProvider @default(SUPABASE)
  storageKey String?   // object key/path
  url        String?   // public URL now; later can be signed URL or null

  createdAt  DateTime @default(now())

  @@index([policyId])
  @@index([kind])
}

model PolicyEvent {
  id        String   @id @default(cuid())
  policyId  String
  policy    Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)

  type      PolicyEventType
  data      Json?
  createdAt DateTime @default(now())

  @@index([policyId])
  @@index([type])
}
